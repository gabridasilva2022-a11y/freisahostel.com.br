<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
  <meta name="google" content="notranslate" />
  <meta http-equiv="Content-Language" content="pt-BR" />
  <meta name="locale" content="pt-BR" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />

  <title>FreiSa Hostel â€” Reserva (v8)</title>
  <meta name="description" content="FreiSa Hostel â€” Hostel em Copacabana. Hospedagem confortÃ¡vel, econÃ´mica e com Ã³tima localizaÃ§Ã£o em Copacabana. Reserve camas ou suÃ­tes com facilidade." />
  <meta name="keywords" content="hostel em Copacabana, hostel, Copacabana, freisa hostel, hospedagem, hospedagem em Copacabana, hospedagem barata em Copacabana" />
  <link rel="canonical" href="https://example.com/freisa-hostel-reserva" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#27ae60;
      --accent-600:#1e8449;
      --danger:#e74c3c;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#F5F7FA;
      --max-width:1200px;
      --shadow: 0 12px 40px rgba(16,24,40,0.10);
      --glass-2: rgba(255,255,255,0.9);
      --radius:12px;
      --transition: 200ms ease;
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; color:#0b1220; background:linear-gradient(180deg,#f6f8fa 0%, #eef2f6 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%; line-height:1.45;
    }
    img{max-width:100%;display:block;height:auto;vertical-align:middle}
    button{cursor:pointer;font:inherit;border:0;background:transparent;padding:0}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max-width);margin:0 auto;padding:0 20px}
    header{position:sticky;top:0;z-index:120;background:rgba(255,255,255,0.75);backdrop-filter: blur(6px);padding:12px 0;border-bottom:1px solid rgba(16,24,40,0.04)}
    .topbar{display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;font-size:1.05rem;color:var(--accent)}
    .spacer{flex:1}
    .top-actions{display:flex;gap:8px;align-items:center}

    /* HERO */
    .hero{position:relative;height:60vh;min-height:380px;overflow:hidden;border-radius:16px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;margin:20px 0}
    .hero-slide{position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity 900ms var(--transition)}
    .hero-slide.active{opacity:1}
    .hero-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(3,7,18,0.24), rgba(3,7,18,0.14));z-index:1}
    .hero-content{position:relative;z-index:2;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;padding:28px;max-width:980px;margin:0 auto}
    .hero h1{font-weight:700;margin:0 0 .3rem;font-size:clamp(1.6rem,5vw,2.8rem)}
    .hero p{margin:0 0 1rem;color:rgba(255,255,255,0.95)}
    .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn{padding:10px 14px;border-radius:10px;background:var(--glass-2);box-shadow:0 8px 20px rgba(3,7,18,0.06);font-weight:600}
    .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:#fff}
    .btn-secondary{background:#fff;color:#111}
    .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.36);width:44px;height:44px;border-radius:999px;display:grid;place-items:center;color:#fff;z-index:3}
    .carousel-btn.left{left:12px}
    .carousel-btn.right{right:12px}
    .hero-indicators{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;display:flex;gap:8px;z-index:3}
    .hero-indicators button{width:10px;height:10px;border-radius:999px;border:0;background:rgba(255,255,255,0.38)}
    .hero-indicators button.active{background:#fff}

    /* Sections */
    section{margin:28px 0}
    h2{font-weight:700;font-size:1.5rem;margin-bottom:8px;text-align:center}
    p.lead{color:var(--muted);margin-bottom:18px;text-align:center}

    /* Rooms */
    .rooms-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:18px}
    .room-card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(16,24,40,0.06);display:flex;flex-direction:column;transition:transform var(--transition)}
    .room-card:hover{transform:translateY(-6px)}
    .room-header{padding:12px 14px;font-weight:700}
    .room-carousel{position:relative;height:200px;overflow:hidden;background:#f7f8fa}
    .room-carousel img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer}
    .room-info{padding:14px;flex:1;display:flex;flex-direction:column}
    .meta{color:var(--muted);font-size:0.95rem;margin-bottom:8px}
    .divider{height:1px;background:#f0f0f0;margin:12px 0}

    /* Benefits (centered content) */
    .benefits-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;max-width:980px;margin:0 auto;justify-items:center}
    .benefit-card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(16,24,40,0.06);display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center;min-height:120px}
    .benefit-icon{width:56px;height:56px;border-radius:12px;background:var(--glass-2);display:grid;place-items:center;font-size:24px}
    .benefit-card h3{margin:0;font-size:1rem}
    .benefit-card p{margin:0;color:var(--muted);font-size:0.95rem}

    /* Testimonials */
    .testimonials-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;max-width:980px;margin:0 auto}
    .testimonial-card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
    .testimonial-text{font-style:italic;color:var(--muted)}
    .testimonial-author{display:flex;align-items:center;gap:12px;margin-top:10px}
    .author-avatar{width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}

    /* Reservation */
    .reservation-section{background:linear-gradient(135deg,#0f1724 0%,#0b1220 100%);padding:18px;border-radius:12px;color:#fff}
    .reservation-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .reservation-card{ background:rgba(255,255,255,0.04);padding:14px;border-radius:10px;color:#fff; border:1px solid rgba(255,255,255,0.03) }
    .form-group label{display:block;margin-bottom:6px;font-weight:700;color:rgba(255,255,255,0.95)}
    input[type="text"], select { width:100%;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#fff;outline:none }

    .btn-select{width:100%;padding:10px;border-radius:10px;background:rgba(255,255,255,0.06);color:#fff}
    .transfer-btn{width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .transfer-btn.active{background:linear-gradient(135deg,#3498db,#2d8fcb);border:0}
    .price-summary{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-top:10px}
    .price-line{display:flex;justify-content:space-between;margin-bottom:6px;color:rgba(255,255,255,0.95)}

    .reservation-card .form-group label { color: #fff !important; }
    .reservation-card [data-role="guestinfo"], .reservation-card [data-role="guestinfo"] * { color: #fff !important; }
    .reservation-card input::placeholder, .reservation-card textarea::placeholder { color: rgba(255,255,255,0.85) !important; opacity: 1; }
    .reservation-card input, .reservation-card textarea, .reservation-card select { color: #fff !important; }

    /* Small Calendar + Generic modal overlay */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));display:none;align-items:center;justify-content:center;z-index:9999;padding:18px;touch-action:pan-y}
    .overlay.show{display:flex}
    .modal.popup-small{background:#fff;border-radius:14px;max-width:720px;width:min(94%,720px);overflow:visible;box-shadow:0 20px 60px rgba(2,6,23,0.6)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #f2f4f6}
    .modal-header h3{margin:0;font-size:1.05rem}
    .modal-body{padding:10px;max-height:70vh;overflow:auto}
    .modal-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid #f2f4f6}

    .calendar-small{width:100%;max-width:100%;margin:0 auto}
    .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px;text-align:center;color:var(--muted);font-weight:700;font-size:0.85rem}
    .calendar-grid-small{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;width:100%;box-sizing:border-box;min-width:0}
    .calendar-day-small{ aspect-ratio: 1/1; display:grid; place-items:center; padding:8px; border-radius:12px; min-height:0; font-size:0.95rem; color:#111; cursor:pointer; background:transparent; overflow:hidden; }
    .calendar-day-small.empty{background:transparent;cursor:default}
    .calendar-day-small.past{opacity:0.85}
    .calendar-day-small .cal-day-num{font-weight:700;font-size:1.05rem;line-height:1}
    .calendar-legend{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:0.9rem;color:var(--muted)}
    .swatch{width:14px;height:14px;border-radius:4px;display:inline-block}

    .beds-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin-top:12px}
    .bed-item{padding:10px;border-radius:8px;border:1px solid #e9e9e9;background:#fff;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;min-height:110px;position:relative;transition:box-shadow 220ms ease, transform 220ms ease, border-color 220ms ease}
    .bed-item img{width:64px;height:48px;object-fit:cover;border-radius:6px}
    .bed-item.reserved{background:var(--danger);color:#fff;border-color:var(--danger);cursor:not-allowed;opacity:0.9}
    .bed-item:not(.reserved){background:var(--accent);color:#fff;border-color:var(--accent)}
    .bed-item.selected{transform:translateY(-6px) scale(1.02);box-shadow:0 14px 40px rgba(39,174,96,0.18);border-color:#1e8449}
    .bed-item.selected::after{ content: 'âœ“'; position: absolute; top:8px; right:8px; background: #27ae60; color: #fff; width:22px; height:22px; border-radius:50%; display:grid; place-items:center; font-weight:700; box-shadow: 0 6px 18px rgba(39,174,96,0.18); transform: scale(0); animation: popIn 260ms cubic-bezier(.2,.9,.2,1) forwards; }
    @keyframes popIn{ from{ transform: scale(0);} to{ transform: scale(1);} }

    .suite-item{padding:12px;border-radius:10px;border:1px solid #eaeaea;background:#fff;text-align:center;cursor:pointer;min-height:110px;display:flex;flex-direction:column;align-items:center;gap:8px}
    .suite-item img{width:64px;height:48px;object-fit:contain;border-radius:6px}
    .suite-item.reserved{background:var(--danger);color:#fff;border-color:var(--danger);cursor:not-allowed}
    .suite-item.selected{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:#fff;border-color:var(--accent)}

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:99999}
    .lightbox.show{display:flex}
    .lightbox img{max-width:94%;max-height:94%}

    footer{padding:28px;text-align:center;color:#111}

    @media (max-width:1024px){
      .hero{height:48vh;min-height:320px}
      .rooms-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
      .testimonials-grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    }
    @media (max-width:640px){
      .container{padding:0 12px;max-width:100%}
      .hero{margin:12px -8px;border-radius:12px;height:44vh;min-height:260px}
      .hero-content{padding:14px}
      .rooms-grid{grid-template-columns:1fr;gap:12px}
      .benefits-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
      .testimonials-grid{grid-template-columns:1fr}
      .reservation-cards{grid-template-columns:1fr}
      .carousel-btn{width:40px;height:40px}
      .modal.popup-small{ width:calc(100% - 32px); max-height:calc(100vh - 96px); border-radius:14px; margin-bottom:6px; overflow:visible; }
      .calendar-grid-small{ gap:8px; padding:8px; max-width:none; width:100%; }
      .calendar-day-small{ min-height:0; padding:8px; border-radius:10px; font-size:0.9rem }
      .calendar-day-small .cal-day-num{ font-size:1rem }
      .modal .modal-footer{ position:sticky; left:0; right:0; bottom:0; max-width:100%; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,0.95), #fff); z-index:6; }
      .modal .modal-body{padding-bottom:84px}
    }

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    button:focus, input:focus, select:focus { outline:3px solid rgba(39,174,96,0.12); outline-offset:2px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="container topbar">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="brand">FreiSa Hostel</div>
          <div style="color:var(--muted);font-size:0.95rem">Copacabana â€¢ Rio de Janeiro</div>
        </div>
        <div class="spacer"></div>
        <div class="top-actions">
          <button class="btn btn-secondary" id="toRoomsBtn">Quartos</button>
          <button class="btn btn-primary" id="toReservationBtn">Reservar</button>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="hero" id="hero" aria-label="ApresentaÃ§Ã£o">
        <div class="hero-slide" style="background-image:url('https://i.imgur.com/tCOCNYU.jpeg')"></div>
        <div class="hero-slide" style="background-image:url('https://i.imgur.com/sjw1dGZ.jpeg')"></div>
        <div class="hero-slide" style="background-image:url('https://i.imgur.com/ftDKRIH.jpeg')"></div>
        <div class="hero-slide" style="background-image:url('https://i.imgur.com/JXIOXmJ.jpeg')"></div>

        <div class="hero-overlay" aria-hidden="true"></div>
        <div class="hero-content">
          <h1>FreiSa Hostel</h1>
          <p>Hospitalidade que conecta pessoas em Copacabana â€” conforto, localizaÃ§Ã£o e bom custoâ€‘benefÃ­cio.</p>
          <div class="actions">
            <button class="btn btn-primary" id="toReservationBtn2">Reservar</button>
            <button class="btn btn-secondary" id="toRoomsBtn2">Quartos</button>
          </div>
        </div>

        <button class="carousel-btn left" id="heroPrev" aria-label="Anterior">â€¹</button>
        <button class="carousel-btn right" id="heroNext" aria-label="PrÃ³ximo">â€º</button>
        <div class="hero-indicators" id="heroIndicators" aria-hidden="true"></div>
      </section>

      <section id="roomsSection" aria-labelledby="roomsTitle">
        <h2 id="roomsTitle">Nossos quartos</h2>
        <p class="lead">Escolha o espaÃ§o que combina com sua viagem â€” dormitÃ³rios, suÃ­tes e espaÃ§os privativos.</p>
        <div class="rooms-grid" id="roomsGrid"></div>
      </section>

      <section>
        <h2>Por que escolher o FreiSa Hostel?</h2>
        <p class="lead">LocalizaÃ§Ã£o, conforto e ambiente acolhedor para viajantes do mundo todo.</p>
        <div class="benefits-grid" id="benefitsGrid"></div>
      </section>

      <section>
        <h2>O que dizem nossos hÃ³spedes</h2>
        <div class="testimonials-grid" id="testimonialsGrid"></div>
      </section>

      <section class="reservation-section" id="reservationSection" aria-labelledby="reservationTitle">
        <h2 id="reservationTitle" style="color:#fff">Reservas</h2>
        <p class="lead" style="color:rgba(255,255,255,0.95)">Verifique disponibilidade e monte sua reserva.</p>
        <div class="reservation-cards" id="reservationCards"></div>
      </section>
    </main>

    <footer>
      <div style="font-weight:700">FreiSa Hostel</div>
      <div>Copacabana, Rio de Janeiro â€” Brasil</div>
      <div>WhatsApp: +55 21 99730-5179</div>
      <div style="opacity:.8;margin-top:8px">Â© 2026 FreiSa Hostel â€” Todos os direitos reservados</div>
    </footer>

    <!-- overlay (small calendar & other modals) -->
    <div class="overlay" id="calendarOverlay" aria-hidden="true"></div>
    <div class="lightbox" id="lightbox" aria-hidden="true"></div>
  </div>

  <script>
  // CONFIG
  const DEFAULT_SHEET_ID = '1QZewic2mbwaksGyIx5MN7mWTukQdxBOb2yheCydFdCM';
  const SHEET_ID = localStorage.getItem('freisa_sheet_id') || DEFAULT_SHEET_ID;
  const SHEET_GIDS = { calendar: '0', pricing: '53054799', rooms: '109166723', beds: '844940838', suites: '1830778583', extras: '1216063608' };
  const SHEET_URL = id => `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=`;
  const CACHE_KEY = 'freisa_sheets_cache_v8';
  const CACHE_DURATION = 10 * 60 * 1000;

  const BED_BUTTON_IMAGE = 'https://i.ibb.co/gZQjxVKZ/images-11.jpg';
  const SUITE_BUTTON_IMAGE = 'https://i.ibb.co/HfZK2CX7/pngtree-luxury-golden-crown-symbol-png-image-14311280.png';
  const BED_ICON_URL = localStorage.getItem('freisa_bed_icon') || '';
  const SUITE_ICON_URL = localStorage.getItem('freisa_suite_icon') || '';

  const ROOM_DESCS_KEY = 'freisa_room_descs';

  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  const ROOM_LABELS = { q007: 'Misto', ar: 'Feminino', jb: 'Only', q777: 'SuÃ­te' };

  // Restore ROOM_CARD_STYLES and ROOM_CAL_COLORS so each card keeps its distinctive color
  const ROOM_CARD_STYLES = {
    ar: 'border:1px solid #5d021f; background: linear-gradient(180deg,#3b0b0b,#5d021f); color: #fff;',
    q007: 'border:1px solid #155e75; background: linear-gradient(180deg,#083344,#0b8793); color:#fff;',
    q777: 'border:1px solid #6b1e6b; background:linear-gradient(180deg,#4b0a4b,#7b1e7b); color:#fff;',
    jb: 'border:1px solid #b45309; background:linear-gradient(180deg,#78350f,#b45309); color:#fff;'
  };

  const ROOM_CAL_COLORS = {
    ar: { available:'#fdecea', reserved:'#5d021f', textAvailable:'#5d021f', textReserved:'#ffffff', swatchAvailable:'#feecec', swatchReserved:'#5d021f' },
    q007: { available:'#e6f6f9', reserved:'#0b8793', textAvailable:'#083344', textReserved:'#ffffff', swatchAvailable:'#e8f7fb', swatchReserved:'#0b8793' },
    q777: { available:'#f3e8fb', reserved:'#7b1e7b', textAvailable:'#4b0a4b', textReserved:'#ffffff', swatchAvailable:'#f7eefb', swatchReserved:'#7b1e7b' },
    jb: { available:'#fff7ed', reserved:'#b45309', textAvailable:'#7a2f05', textReserved:'#ffffff', swatchAvailable:'#fff3e0', swatchReserved:'#b45309' }
  };

  const calSmallState = { roomId: null, currentDate: new Date(), onSelect: null };

  // Default extras
  const DEFAULT_EXTRAS = {
    early_checkin: 30,
    late_checkout: 30,
    transfer_arrival: 150,
    transfer_departure: 150
  };

  // Global sheets object and reserved maps
  let SHEETS = { calendar:[], pricing:[], rooms:[], beds:[], suites:[], extras:[] };
  let RESERVED = { reservedBeds: {}, reservedSuites: {}, roomBlockedDates: {}, reservedAllBeds: new Set(), reservedAllSuites: new Set() };

  // CSV parser (unchanged)
  function parseCSV(csvText){
    if(!csvText) return [];
    const rows=[];
    let cur='', row=[], inQ=false;
    for(let i=0;i<csvText.length;i++){
      const ch=csvText[i], nx=csvText[i+1];
      if(ch==='"'){
        if(inQ && nx==='"'){ cur+='"'; i++; continue }
        inQ=!inQ; continue
      }
      if(ch===',' && !inQ){ row.push(cur); cur=''; continue }
      if((ch==='\n' || ch==='\r') && !inQ){
        if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
        continue
      }
      cur+=ch
    }
    if(cur!==''||row.length){ row.push(cur); rows.push(row) }
    if(!rows.length) return [];
    const headers = rows[0].map(h=>h.trim());
    return rows.slice(1).map(r=>{ const o={}; headers.forEach((h,i)=> o[h]=(r[i]||'').trim()); return o; })
  }

  // Date helpers (unchanged)
  function tryParseDateToISO(s){
    if(!s) return null;
    s = String(s).trim();
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
      const parts = s.split('/');
      return `${parts[2].padStart(4,'0')}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    const parsed = new Date(s);
    if(!isNaN(parsed.getTime())){
      return `${parsed.getFullYear()}-${String(parsed.getMonth()+1).padStart(2,'0')}-${String(parsed.getDate()).padStart(2,'0')}`;
    }
    return null;
  }
  function datesBetween(startStr, endStr){
    const startISO = tryParseDateToISO(startStr);
    const endISO = tryParseDateToISO(endStr);
    if(!startISO || !endISO) return [];
    const start = parseLocalDate(startISO);
    const end = parseLocalDate(endISO);
    if(!start || !end) return [];
    const dates = [];
    for(let d = new Date(start); d < end; d.setDate(d.getDate()+1)){
      dates.push(formatLocalDateJS(new Date(d)));
    }
    return dates;
  }
  function addDateToMap(map, key, dateIso){
    if(!key || !dateIso) return;
    map[key] = map[key] || new Set();
    map[key].add(dateIso);
  }
  function addRangeToMap(map, key, startIso, endIso){
    if(!key || !startIso || !endIso) return;
    const dates = datesBetween(startIso, endIso);
    if(!dates.length) return;
    map[key] = map[key] || new Set();
    dates.forEach(d => map[key].add(d));
  }
  function formatLocalDateJS(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function parseLocalDate(str){ if(!str) return null; const [y,m,d] = str.split('-').map(Number); return new Date(y,m-1,d); }
  function formatBR(dStr){ if(!dStr) return ''; const d = parseLocalDate(dStr); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"]/g, function(tag){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[tag]); }); }
  function formatCurrency(v){ const n = Number(v || 0); return 'R$ ' + n.toFixed(2).replace('.', ','); }

  // === normalizeBedId === (unchanged)
  function normalizeBedId(roomId, rawBedId){
    if(!rawBedId) return null;
    let s = String(rawBedId).trim();
    if(!s) return null;

    // Already prefix+num (misto3, feminino2, only5)
    const already = /^([A-Za-z]+)\s*-?\s*(\d+)$/i.exec(s);
    if(already){
      const p = already[1].toLowerCase();
      const n = String(Number(already[2]));
      if(!/^c$|^ct$/i.test(p)) return `${p}${n}`;
    }

    // C patterns (C1-T, C1-B, Ct3, C3)
    const cMatch = /^C(?:t|T)?[-_\s]?(\d+)(?:[-_\s]?([TBtb]))?$/i.exec(s) || /^C(\d+)(?:[-_\s]?([TBtb]))?$/i.exec(s);
    if(cMatch){
      const idx = Number(cMatch[1]);
      const pos = (cMatch[2] || '').toUpperCase();
      const finalNumber = (pos === 'B') ? (idx * 2) : (idx * 2 - 1);
      const prefixMap = { q007: 'misto', ar: 'feminino', jb: 'only' };
      const prefix = prefixMap[roomId] || String(roomId).toLowerCase();
      return `${prefix}${finalNumber}`;
    }

    // Any digits => prefix + digit
    const digits = s.match(/(\d+)/);
    if(digits){
      const num = Number(digits[1]);
      const prefixMap = { q007: 'misto', ar: 'feminino', jb: 'only' };
      const prefix = prefixMap[roomId] || String(roomId).toLowerCase();
      return `${prefix}${num}`;
    }

    // Fallback
    return s.replace(/\s+/g, '').toLowerCase();
  }
  // === end normalize ===

  // Build reserved maps (unchanged logic; suites reserved mapping will still be used)
  function buildReservedMapsFromSheets(){
    const reservedBeds = {};
    const reservedSuites = {};
    const roomBlockedDates = {};
    const reservedAllBeds = new Set();
    const reservedAllSuites = new Set();

    // calendar sheet
    (SHEETS.calendar || []).forEach(row => {
      const status = String(row.status || row.availability || row.state || '').toLowerCase();
      const dateIso = tryParseDateToISO(row.date || row.day || row.dt);
      const startIso = tryParseDateToISO(row.checkin || row.start || row.from);
      const endIso = tryParseDateToISO(row.checkout || row.end || row.to);
      const roomId = (row.room_id || row.room || row.roomid || row.roomId || '').trim();
      const rawBed = row.bed_id || row.bed || row.resource || '';
      const suiteId = row.suite_id || row.suite || row.suÃ­te;

      const isReservedFlag = ['reserved','booked','blocked','unavailable','ocupado','indisponivel','indisponÃ­vel','yes','y','1'].some(s => status.includes(s));

      let bedId = null;
      if(rawBed) bedId = normalizeBedId(roomId, rawBed);

      if(bedId){
        if(startIso && endIso) addRangeToMap(reservedBeds, bedId, startIso, endIso);
        else if(dateIso && isReservedFlag) addDateToMap(reservedBeds, bedId, dateIso);
        else if(isReservedFlag && !dateIso && !startIso) reservedAllBeds.add(bedId);
      }
      if(suiteId){
        if(startIso && endIso) addRangeToMap(reservedSuites, suiteId.trim(), startIso, endIso);
        else if(dateIso && isReservedFlag) addDateToMap(reservedSuites, suiteId.trim(), dateIso);
        else if(isReservedFlag && !dateIso && !startIso) reservedAllSuites.add(suiteId.trim());
      }
      if(roomId && isReservedFlag){
        if(startIso && endIso) addRangeToMap(roomBlockedDates, roomId.trim(), startIso, endIso);
        else if(dateIso) addDateToMap(roomBlockedDates, roomId.trim(), dateIso);
      }
    });

    // beds sheet
    (SHEETS.beds || []).forEach(row => {
      const rawBed = row.bed_id || row.bed || row.id || row.name || '';
      const roomId = (row.room_id || row.room || row.roomid || row.roomId || '').trim();
      const startIso = tryParseDateToISO(row.checkin || row.start || row.from);
      const endIso = tryParseDateToISO(row.checkout || row.end || row.to);
      const dateIso = tryParseDateToISO(row.date || row.day);
      const status = String(row.status || row.state || row.availability || '').toLowerCase();

      if(!rawBed) return;
      const bedId = normalizeBedId(roomId, rawBed);
      if(!bedId) return;

      const isReservedFlag = ['reserved','booked','blocked','unavailable','ocupado','indisponivel','indisponÃ­vel','yes','y','1'].some(s => status.includes(s));

      if(startIso && endIso) addRangeToMap(reservedBeds, bedId, startIso, endIso);
      else if(dateIso) addDateToMap(reservedBeds, bedId, dateIso);
      else if(isReservedFlag) reservedAllBeds.add(bedId);
    });

    // suites sheet
    (SHEETS.suites || []).forEach(row => {
      const suiteId = row.suite_id || row.suite || row.id || row.name;
      const startIso = tryParseDateToISO(row.checkin || row.start || row.from);
      const endIso = tryParseDateToISO(row.checkout || row.end || row.to);
      const dateIso = tryParseDateToISO(row.date || row.day);
      const status = String(row.status || row.state || row.availability || '').toLowerCase();
      if(!suiteId) return;
      const isReservedFlag = ['reserved','booked','blocked','unavailable','ocupado','indisponivel','indisponÃ­vel','yes','y','1'].some(s => status.includes(s));
      if(startIso && endIso) addRangeToMap(reservedSuites, suiteId.trim(), startIso, endIso);
      else if(dateIso) addDateToMap(reservedSuites, suiteId.trim(), dateIso);
      else if(isReservedFlag) reservedAllSuites.add(suiteId.trim());
    });

    RESERVED = { reservedBeds, reservedSuites, roomBlockedDates, reservedAllBeds, reservedAllSuites };
    try{
      localStorage.setItem('freisa_reserved_cache_v8', JSON.stringify({
        timestamp: Date.now(),
        beds: Object.keys(reservedBeds).length,
        suites: Object.keys(reservedSuites).length,
        rooms: Object.keys(roomBlockedDates).length,
        alwaysBlockedBeds: Array.from(reservedAllBeds).length,
        alwaysBlockedSuites: Array.from(reservedAllSuites).length
      }));
    }catch(e){}
    return RESERVED;
  }

  // Helper to detect suite rooms (either the previous group 'q777' or individual suite entries with isSuite flag)
  function isSuiteRoomId(roomId){
    if(!roomId) return false;
    if(String(roomId).toLowerCase() === 'q777') return true;
    const r = staticRooms.find(s => String(s.roomId) === String(roomId));
    return !!(r && r.isSuite);
  }

  function isResourceFreeForRange(reservedMap, resourceId, start, end, reservedAllSet){
    if(!resourceId) return true;
    if(reservedAllSet && reservedAllSet.has(resourceId)) return false;
    const s = reservedMap[resourceId];
    if(!start || !end) return !(s && s.size > 0);
    const dates = datesBetween(start, end);
    if(!dates.length) return true;
    if(!s) return true;
    for(const d of dates) if(s.has(d)) return false;
    return true;
  }

  function getBedsForRoom(roomId){
    if(SHEETS && Array.isArray(SHEETS.beds) && SHEETS.beds.length){
      const rows = SHEETS.beds.filter(r => {
        const rr = (r.room_id || r.room || r.roomid || r.roomId || '').trim();
        return rr && String(rr) === String(roomId);
      });
      if(rows.length){
        return rows.map((row, idx) => {
          const rawId = (row.bed_id || row.bed || row.id || row.name || (`${roomId}-${idx+1}`)).trim();
          const id = normalizeBedId(roomId, rawId) || `${roomId}-${idx+1}`;
          const label = (row.label || row.name || row.bed || row.bed_id || id).trim();
          return { id, label };
        }).filter(Boolean);
      }
    }
    const prefixMap = { q007: 'misto', ar: 'feminino', jb: 'only' };
    const prefix = prefixMap[roomId] || (roomId === 'q777' ? '' : (`${roomId}`));
    if(roomId === 'q777' || isSuiteRoomId(roomId)) return [];
    const beds = [];
    for(let i=1;i<=14;i++){
      const id = `${prefix}${i}`;
      const label = `${id}`;
      beds.push({ id, label });
    }
    return beds;
  }

  function checkAvailability(roomId, checkin, checkout){
    if(!RESERVED || !RESERVED.reservedBeds) buildReservedMapsFromSheets();
    const { reservedBeds, reservedSuites, roomBlockedDates, reservedAllBeds, reservedAllSuites } = RESERVED;

    if(checkin && checkout && roomBlockedDates[roomId]){
      const dates = datesBetween(checkin, checkout);
      for(const d of dates) if(roomBlockedDates[roomId].has(d)) return { availableBeds: [], availableSuites: [], isAvailable: false };
    }

    // For suite rooms (either grouped or individual suite entries) treat by suite reservation mapping
    if(isSuiteRoomId(roomId)){
      // If this is the grouped 'q777' the code will look into SHEETS.suites; for individual suite rooms, attempt to use their suiteId property
      const allSuites = [];
      // Pull suite IDs from SHEETS if present
      if(SHEETS && Array.isArray(SHEETS.suites) && SHEETS.suites.length){
        SHEETS.suites.forEach(r => {
          const sid = (r.suite_id || r.suite || r.id || r.name || '').trim();
          if(sid) allSuites.push(sid);
        });
      }
      // If no suites found in SHEETS, fallback to individual staticRooms that are suites
      if(allSuites.length === 0){
        staticRooms.forEach(r => { if(r.isSuite && r.suiteId) allSuites.push(r.suiteId); });
      }
      // Final fallback
      if(allSuites.length === 0) allSuites.push('S1','S2','S3');
      const availableSuites = allSuites.filter(sid => isResourceFreeForRange(reservedSuites, sid, checkin, checkout, reservedAllSuites));
      // If roomId is an individual suite (e.g. 's1'), we check availability only for that suiteId if present
      const staticRoom = staticRooms.find(r => r.roomId === roomId);
      if(staticRoom && staticRoom.isSuite && staticRoom.suiteId){
        const sid = staticRoom.suiteId;
        const avail = availableSuites.includes(sid);
        return { availableBeds: [], availableSuites: avail ? [sid] : [], isAvailable: avail };
      }
      return { availableBeds: [], availableSuites, isAvailable: availableSuites.length > 0 };
    } else {
      const allBedsObjs = getBedsForRoom(roomId);
      const allBeds = allBedsObjs.map(b=>b.id);
      const availableBeds = allBeds.filter(bid => isResourceFreeForRange(reservedBeds, bid, checkin, checkout, RESERVED.reservedAllBeds));
      return { availableBeds, availableSuites: [], isAvailable: availableBeds.length > 0 };
    }
  }

  function isRoomAvailableOnDate(roomId, dateIso){
    if(!dateIso) return true;
    if(!RESERVED || !RESERVED.reservedBeds) buildReservedMapsFromSheets();
    const { reservedBeds, reservedSuites, roomBlockedDates, reservedAllBeds, reservedAllSuites } = RESERVED;
    if(roomBlockedDates[roomId] && roomBlockedDates[roomId].has(dateIso)) return false;
    if(isSuiteRoomId(roomId)){
      const allSuites = [];
      if(SHEETS && Array.isArray(SHEETS.suites) && SHEETS.suites.length){
        SHEETS.suites.forEach(r => {
          const sid = (r.suite_id || r.suite || r.id || r.name || '').trim();
          if(sid) allSuites.push(sid);
        });
      }
      if(allSuites.length === 0) {
        staticRooms.forEach(r => { if(r.isSuite && r.suiteId) allSuites.push(r.suiteId); });
      }
      if(allSuites.length === 0) allSuites.push('S1','S2','S3');
      for(const s of allSuites){
        if(reservedAllSuites.has(s)) continue;
        const sset = reservedSuites[s];
        if(!sset || !sset.has(dateIso)) return true;
      }
      // If this is an individual suite, ensure at least one suite (itself) is available
      const staticRoom = staticRooms.find(r => r.roomId === roomId);
      if(staticRoom && staticRoom.isSuite && staticRoom.suiteId){
        const sid = staticRoom.suiteId;
        if(reservedAllSuites.has(sid)) return false;
        const sset = reservedSuites[sid];
        return !(sset && sset.has(dateIso));
      }
      return false;
    } else {
      const allBedsObjs = getBedsForRoom(roomId);
      for(const bed of allBedsObjs){
        if(RESERVED.reservedAllBeds.has(bed.id)) continue;
        const s = reservedBeds[bed.id];
        if(!s || !s.has(dateIso)) return true;
      }
      return false;
    }
  }

  function getBasePrice(roomId){
    const priceKeys = { jb: 'base_price_nice_place', ar: 'base_price_quarto_feminino', q007: 'base_price_quarto_misto', q777: 'base_price_suites' };
    let key = priceKeys[roomId];
    if (!key){
      // If this is an individual suite room, use suites base price
      const room = staticRooms.find(r => r.roomId === roomId);
      if(room && room.isSuite) key = 'base_price_suites';
    }
    if (!key) return 100;
    const extra = (SHEETS.extras || []).find(e => e.key === key);
    return extra ? parseFloat(extra.price) : 100;
  }

  function getPriceForDate(roomId, dateStr){
    if(!dateStr) return getBasePrice(roomId);
    const d = parseLocalDate(dateStr);
    if(!d) return getBasePrice(roomId);
    const isFebruary = d.getMonth() === 1;
    if(isFebruary){
      if(isSuiteRoomId(roomId)) return 1000;
      if(['jb','q007','ar'].includes(roomId)) return 500;
    }
    // Try direct match in pricing sheet; if not found and this is an individual suite, try 'q777' pricing fallback
    const priceRow = (SHEETS.pricing || []).find(p => p.room_id === roomId && p.date === dateStr);
    if(priceRow) return parseFloat(priceRow.price);
    if(isSuiteRoomId(roomId)){
      const suiteFallback = (SHEETS.pricing || []).find(p => (p.room_id === 'q777' || p.room_id === 'suites' || p.room_id === 'suite') && p.date === dateStr);
      if(suiteFallback) return parseFloat(suiteFallback.price);
    }
    return getBasePrice(roomId);
  }

  function computeDynamicPricing(roomId, checkin, checkout, guests=1, selectedBeds=[], selectedSuites=[]){
    if (!checkin || !checkout) return { nightlyPrices: [], baseTotal: 0 };
    const start = parseLocalDate(checkin);
    const end = parseLocalDate(checkout);
    const nights = Math.ceil((end - start) / (1000*60*60*24));
    const nightlyPrices = [];
    let baseTotal = 0;
    const roomIsSuite = isSuiteRoomId(roomId);
    for (let i = 0; i < nights; i++){
      const d = new Date(start);
      d.setDate(d.getDate() + i);
      const dateStr = formatLocalDateJS(d);
      const pricePerUnit = getPriceForDate(roomId, dateStr);
      let nightTotal;
      if (roomIsSuite) {
        // For suites the unit is per-suite
        nightTotal = pricePerUnit * (selectedSuites.length || 1);
      } else {
        nightTotal = pricePerUnit * guests;
      }
      nightlyPrices.push({ date: dateStr, price: pricePerUnit, total: nightTotal });
      baseTotal += nightTotal;
    }
    return { nightlyPrices, baseTotal };
  }

  function getExtraPrice(key){
    if(!key) return 0;
    const r = (SHEETS.extras || []).find(e => e.key === key);
    if(r && r.price) return parseFloat(r.price);
    return DEFAULT_EXTRAS[key] || 0;
  }

  const bedSvg = `<svg viewBox="0 0 24 24" width="34" height="22" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="8" width="20" height="8" rx="1.5" stroke="#111" stroke-width="1.2" fill="none"/><path d="M4 16v2" stroke="#111" stroke-width="1.2" stroke-linecap="round"/><path d="M20 16v2" stroke="#111" stroke-width="1.2" stroke-linecap="round"/><rect x="4" y="9" width="6" height="3" rx="1" fill="#111" opacity="0.08"/></svg>`;
  const suiteSvg = `<svg viewBox="0 0 24 24" width="48" height="36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="6" width="20" height="12" rx="2" stroke="#111" stroke-width="1.2" fill="none"/><circle cx="7" cy="12" r="1.5" fill="#111" /><rect x="12" y="9" width="6" height="6" rx="1" fill="#111" opacity="0.06" /></svg>`;
  function getBedIconHtml(){ if(BED_ICON_URL && BED_ICON_URL.trim()){ return `<img src="${BED_ICON_URL}" alt="cama" style="width:34px;height:22px;object-fit:contain;display:block;margin:0 auto 6px" />`; } return bedSvg; }
  function getSuiteIconHtml(){ if(SUITE_ICON_URL && SUITE_ICON_URL.trim()){ return `<img src="${SUITE_ICON_URL}" alt="suÃ­te" style="width:48px;height:36px;object-fit:contain;display:block;margin:0 auto 6px" />`; } return suiteSvg; }

  function bedIdToLabel(roomId, bedId){
    if(!bedId) return bedId;
    const mm = /^misto(\d+)$/i.exec(bedId);
    if(mm) return `Misto ${mm[1]}`;
    const mf = /^feminino(\d+)$/i.exec(bedId);
    if(mf) return `Feminino ${mf[1]}`;
    const mo = /^(only)(\d+)$/i.exec(bedId);
    if(mo) return `Only ${mo[2]}`;
    const mC = /^C(\d+)-([TB])$/.exec(bedId);
    if(mC){
      const idx = Number(mC[1]); const pos = mC[2];
      const number = pos === 'T' ? (idx * 2 - 1) : (idx * 2);
      return `${ROOM_LABELS[roomId] || 'Cama'} ${number}`;
    }
    const simple = /([A-Za-z]+)(\d+)/.exec(bedId);
    if(simple) {
      const prefix = simple[1].charAt(0).toUpperCase() + simple[1].slice(1).toLowerCase();
      return `${prefix} ${simple[2]}`;
    }
    return bedId;
  }

  // staticRooms now contains the original dorms + three separate suite cards (S1, S2, S3)
  const staticRooms = [
    {
      name: 'Quarto Feminino FreiSa',
      roomId: 'ar',
      location: 'Copacabana, RJ',
      beds: '14 camas',
      bathrooms: '4 banheiros',
      images: [
        'https://i.imgur.com/DDQNMmz.jpeg',
        'https://i.imgur.com/TuYE4QA.jpeg',
        'https://i.imgur.com/B2ZUMiU.jpeg',
        'https://i.imgur.com/usi1hKM.jpeg',
        'https://i.imgur.com/t5dIg5D.jpeg'
      ],
      description:
        'EspaÃ§o exclusivo feminino pensado para quem busca conforto e seguranÃ§a. O ambiente Ã© limpo diariamente e hÃ¡ Ã¡reas comuns integradas: cozinha equipada, sala com TV e Ã¡rea externa para socializaÃ§Ã£o. Localizado a poucos quarteirÃµes da praia.'
    },
    {
      name: 'Quarto Misto',
      roomId: 'q007',
      location: 'Copacabana, RJ',
      beds: '14 camas',
      bathrooms: 'Banheiros compartilhados',
      images: [
        'https://i.imgur.com/TuYE4QA.jpeg',
        'https://i.imgur.com/DDQNMmz.jpeg',
        'https://i.imgur.com/B2ZUMiU.jpeg',
        'https://i.imgur.com/usi1hKM.jpeg',
        'https://i.imgur.com/t5dIg5D.jpeg'
      ],
      description:
        'DormitÃ³rio misto confortÃ¡vel e arejado, ideal para viajantes solo ou grupos que querem economizar sem perder seguranÃ§a. Banheiros compartilhados bem mantidos e Ã¡reas comuns amplas.'
    },

    // --- Suites split into 3 separate cards as requested ---
    {
      name: 'SuÃ­te 1',
      roomId: 's1',
      suiteId: 'S1',
      isSuite: true,
      location: 'Copacabana, RJ',
      beds: '1 suÃ­te',
      bathrooms: 'Banheiro privativo',
      images: [
        'https://i.imgur.com/b7qvANs.jpeg'
      ],
      description: 'SuÃ­te 1 â€” quarto aconchegante, ideal para casal. Foto representativa acima.'
    },
    {
      name: 'SuÃ­te 2',
      roomId: 's2',
      suiteId: 'S2',
      isSuite: true,
      location: 'Copacabana, RJ',
      beds: '1 suÃ­te',
      bathrooms: 'Banheiro privativo',
      images: [
        'https://i.imgur.com/MFmbhwu.jpeg',
        'https://i.imgur.com/7f97Qlj.jpeg'
      ],
      description: 'SuÃ­te 2 â€” imagens mostram cama e Ã¡rea de apoio. Ideal para casal ou viagem a dois.'
    },
    {
      name: 'SuÃ­te 3',
      roomId: 's3',
      suiteId: 'S3',
      isSuite: true,
      location: 'Copacabana, RJ',
      beds: '1 suÃ­te',
      bathrooms: 'Banheiro privativo',
      images: [
        'https://i.imgur.com/ld63HJl.jpeg',
        'https://i.imgur.com/ykCgL6E.jpeg'
      ],
      description: 'SuÃ­te 3 â€” suÃ­te com banheiro privativo e detalhes de conforto.'
    },

    {
      name: 'Only womans (100% feminino)',
      roomId: 'jb',
      location: 'Copacabana, RJ',
      beds: '14 camas',
      bathrooms: '2 banheiros',
      images: ['https://i.imgur.com/OddkKoI.jpeg','https://i.imgur.com/W9koWkI.jpeg','https://i.imgur.com/yEaKK3Q.jpeg'],
      description:
        'Quarto â€œOnly womansâ€ â€” ambiente 100% feminino, relaxante e bem localizado. PrÃ³ximo a mercados, padarias e transporte pÃºblico.'
    }
  ];

  function loadSavedRoomDescs(){ try{ const raw = localStorage.getItem(ROOM_DESCS_KEY); if(!raw) return {}; return JSON.parse(raw); }catch{ return {}; } }
  function saveRoomDesc(roomId, desc){ try{ const map = loadSavedRoomDescs(); map[roomId] = desc; localStorage.setItem(ROOM_DESCS_KEY, JSON.stringify(map)); }catch(e){ console.warn(e); } }
  function applySavedRoomDescs(){ const map = loadSavedRoomDescs(); if(!map) return; staticRooms.forEach(r => { if(map[r.roomId]) r.description = map[r.roomId]; }); }

  function renderBenefits(){ const container = qs('#benefitsGrid'); if(!container) return; const benefits = [ { icon:'ðŸ“', title:'LocalizaÃ§Ã£o EstratÃ©gica', text:'Em Copacabana, perto de tudo que vocÃª precisa' },{ icon:'ðŸ’°', title:'Custo-BenefÃ­cio', text:'PreÃ§os justos para uma experiÃªncia incrÃ­vel' },{ icon:'ðŸ”’', title:'Conforto e SeguranÃ§a', text:'Sua estadia tranquila Ã© nossa prioridade' },{ icon:'ðŸ¤', title:'Ambiente Social', text:'ConheÃ§a viajantes do mundo todo' },{ icon:'ðŸ³', title:'Estrutura PrÃ¡tica', text:'Cozinha compartilhada e Ã¡reas comuns' },{ icon:'ðŸŒ³', title:'ExperiÃªncia Carioca', text:'Viva o Rio de Janeiro autenticamente' } ]; container.innerHTML = benefits.map(b=>`<div class="benefit-card"><div class="benefit-icon" aria-hidden="true">${b.icon}</div><h3>${b.title}</h3><p>${b.text}</p></div>`).join(''); }

  function renderTestimonials(){ const container = qs('#testimonialsGrid'); if(!container) return; const testimonials=[ { text:'Fiquei 4 noites em Copacabana. LocalizaÃ§Ã£o excelente...', name:'HÃ³spede', location:'Brasil' },{ text:'Minha hospedagem foi super tranquila...', name:'HÃ³spede', location:'Internacional' },{ text:'LocalizaÃ§Ã£o excelente; o proprietÃ¡rio estava disponÃ­vel...', name:'HÃ³spede', location:'SÃ£o Paulo' } ]; container.innerHTML = testimonials.map(t=>`<div class="testimonial-card"><div class="testimonial-text">"${t.text}"</div><div style="margin-top:8px">ðŸŒŸðŸŒŸðŸŒŸðŸŒŸðŸŒŸ</div><div class="testimonial-author"><div class="author-avatar">${t.name[0]}</div><div><div style="font-weight:700">${t.name}</div><div style="color:var(--muted)">${t.location}</div></div></div></div>`).join(''); }

  function renderRoomsGrid(){ const container = qs('#roomsGrid'); if(!container) return;
    container.innerHTML = staticRooms.map((r, idx)=>{ 
      const firstImage = (r.images && r.images[0]) || '';
      const indicators = r.images && r.images.length>1 ? `<div class="hero-indicators" data-room="${idx}">${r.images.map((_,i)=>`<button data-i="${i}" class="${i===0?'active':''}" aria-label="slide ${i+1}"></button>`).join('')}</div>` : '';
      const nav = r.images && r.images.length>1 ? `<button class="carousel-btn left" data-idx="${idx}" data-action="prev" aria-label="Anterior">â€¹</button><button class="carousel-btn right" data-idx="${idx}" data-action="next" aria-label="PrÃ³ximo">â€º</button>` : '';
      const shortDesc = (r.description || '').length > 140 ? (r.description.slice(0,140).trim() + 'â€¦') : (r.description || '');
      const metaHtml = `<div class="meta">${r.location} Â· ${r.beds} Â· ${r.bathrooms}</div>`;

      return `<article class="room-card" data-roomid="${r.roomId}"><div class="room-header">${r.name}</div><div class="room-carousel" id="roomCarousel${idx}"><img src="${firstImage}" loading="lazy" alt="${r.name}" data-idx="0" data-room="${idx}" />${nav}${indicators}</div><div class="room-info">${metaHtml}<div class="divider"></div><div style="color:var(--muted)">${shortDesc}</div><div style="margin-top:auto;display:flex;gap:8px;margin-top:12px"><button class="btn" data-detail="${idx}" style="margin-top:0">Mostrar mais</button></div></div></article>` 
    }).join('');

    staticRooms.forEach((r, idx)=>{ const carousel = qs(`#roomCarousel${idx}`); if(!carousel) return; const img = carousel.querySelector('img'); let cur=0; function show(i){ if(!r.images || !r.images.length) return; cur = ((i % r.images.length)+r.images.length)%r.images.length; img.src = r.images[cur]; img.setAttribute('loading','lazy'); const inds = carousel.querySelectorAll('.hero-indicators button'); inds.forEach((b,bi)=> b.classList.toggle('active', bi===cur)); } const nextBtn = carousel.querySelector('[data-action="next"]'); const prevBtn = carousel.querySelector('[data-action="prev"]'); if(nextBtn) nextBtn.addEventListener('click', ()=> show(cur+1)); if(prevBtn) prevBtn.addEventListener('click', ()=> show(cur-1)); carousel.querySelectorAll('.hero-indicators button').forEach((b,i)=> b.addEventListener('click', ()=> show(i))); img.addEventListener('click', ()=> openLightbox(r.images || [], cur)); });
    qsa('[data-detail]').forEach(btn => btn.addEventListener('click', e => { const idx = Number(e.currentTarget.getAttribute('data-detail')); openDetailModal(staticRooms[idx]); }));
  }

  function openLightbox(images, index=0){ const lb = qs('#lightbox'); lb.innerHTML = `<div style="position:relative;max-width:95%;max-height:95%"><button style="position:absolute;right:-10px;top:-10px;background:#fff;border-radius:999px;width:40px;height:40px;border:0;font-size:20px" id="lbClose">Ã—</button><img id="lbImg" src="${images[index]||''}" loading="lazy" alt="" /></div>`; lb.classList.add('show'); lb.setAttribute('aria-hidden','false'); let cur=index; function show(i){ if(!images || !images.length) return; cur = ((i % images.length)+images.length)%images.length; qs('#lbImg').src = images[cur]; } function onKey(e){ if(e.key==='Escape') close(); if(e.key==='ArrowRight') show(cur+1); if(e.key==='ArrowLeft') show(cur-1); } function close(){ lb.classList.remove('show'); lb.innerHTML=''; lb.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', onKey); } qs('#lbClose')?.addEventListener('click', close); lb.addEventListener('click', ev=>{ if(ev.target===lb) close(); }); document.addEventListener('keydown', onKey); }

  function openDetailModal(room){
    const overlay = qs('#calendarOverlay');
    const iconHtml = room.isSuite ? getSuiteIconHtml() : getBedIconHtml();
    const currentDesc = room.description || '';
    // For individual suite cards show their gallery inline
    let suiteHtml = '';
    if(room.isSuite){
      suiteHtml = `<div style="margin-top:12px; font-weight:700; color:var(--muted)">Esta Ã© ${escapeHtml(room.name)} (${escapeHtml(room.suiteId || '')}). Clique em "Ver fotos" para ampliar as imagens.</div>`;
      suiteHtml += `<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">`;
      (room.images || []).forEach((imgUrl, i) => {
        suiteHtml += `<div style="width:48%;"><img src="${imgUrl}" alt="${escapeHtml(room.name)} foto ${i+1}" style="width:100%;height:120px;object-fit:cover;border-radius:8px" /></div>`;
      });
      suiteHtml += `</div><div style="margin-top:8px"><button class="btn" data-action="view-suite" data-room="${room.roomId}">Ver fotos</button></div>`;
    }

    overlay.innerHTML = `
      <div class="modal popup-small" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
        <div class="modal-header">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:48px;height:48px;border-radius:8px;display:grid;place-items:center">${iconHtml}</div>
            <div>
              <h3 id="detailTitle" style="margin:0">${room.name}</h3>
              <div style="color:var(--muted);font-size:0.95rem">${room.location} Â· ${room.beds} Â· ${room.bathrooms}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="modal-close btn" id="detailClose" aria-label="Fechar">Ã—</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="detailView">
            <p id="detailDesc" style="color:var(--muted);white-space:pre-wrap">${escapeHtml(currentDesc)}</p>
            ${suiteHtml}
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="detailCloseFooter">Fechar</button>
        </div>
      </div>
    `;
    overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');

    function closeAll(){
      overlay.classList.remove('show');
      overlay.innerHTML = '';
      overlay.setAttribute('aria-hidden','true');
      document.removeEventListener('keydown', onKey);
    }
    function onKey(e){
      if(e.key === 'Escape') closeAll();
    }

    // Open gallery for this suite
    overlay.querySelectorAll('[data-action="view-suite"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const rid = ev.currentTarget.getAttribute('data-room');
        const r = staticRooms.find(x => x.roomId === rid);
        if(r && Array.isArray(r.images) && r.images.length) openLightbox(r.images, 0);
      });
    });

    qs('#detailClose')?.addEventListener('click', closeAll);
    qs('#detailCloseFooter')?.addEventListener('click', closeAll);
    overlay.addEventListener('click', ev => { if(ev.target === overlay) closeAll(); });
    document.addEventListener('keydown', onKey);
  }

  // Beds / Suites modals (openBedsModal & openSuitesModal kept for dorms and for grouped behavior; selecting individual suite is simpler in reservation card)
  function openBedsModal({ roomId, maxBeds = 1, preselected = [], checkin = null, checkout = null, onConfirm = null } = {}) {
    const overlay = qs('#calendarOverlay');
    overlay.innerHTML = '';
    overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');

    const avail = checkAvailability(roomId, checkin, checkout);
    const bedObjs = getBedsForRoom(roomId) || [];

    const topBeds = [], bottomBeds = [];
    if(bedObjs.length){
      bedObjs.forEach(b => {
        const m = String(b.id).match(/(\d+)$/);
        const n = m ? Number(m[1]) : null;
        if(n !== null){
          if(n % 2 === 1) topBeds.push({ id: b.id, label: b.label });
          else bottomBeds.push({ id: b.id, label: b.label });
        } else {
          if(topBeds.length <= bottomBeds.length) topBeds.push({ id: b.id, label: b.label });
          else bottomBeds.push({ id: b.id, label: b.label });
        }
      });
    } else {
      const prefixMap = { q007: 'misto', ar: 'feminino', jb: 'only' };
      const prefix = prefixMap[roomId] || `${roomId}`;
      for (let i=1;i<=14;i++){
        const id = `${prefix}${i}`;
        const label = `${id}`;
        if(i % 2 === 1) topBeds.push({ id, label });
        else bottomBeds.push({ id, label });
      }
    }

    const allBeds = topBeds.concat(bottomBeds).map(b=>b.id);
    const availableSet = new Set(avail.availableBeds || []);
    const reservedSet = new Set(allBeds.filter(bid => !availableSet.has(bid) || RESERVED.reservedAllBeds.has(bid)));

    let selected = Array.from(preselected || []).slice(0, maxBeds);

    const modal = document.createElement('div');
    modal.className = 'modal popup-small';
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-modal','true');
    modal.innerHTML = `
      <div class="modal-header">
        <h3>Selecionar camas</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="bedsClose" class="btn" aria-label="Fechar">Ã—</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="color:var(--muted);margin-bottom:8px">Selecione exatamente ${maxBeds} cama(s). ${checkin && checkout ? `PerÃ­odo: ${formatBR(checkin)} â€” ${formatBR(checkout)}` : ''}</div>
        <div style="font-weight:700;margin-top:6px">Camas â€” Superior (Ã­mpares)</div>
        <div class="beds-grid" id="bedsGridTop"></div>
        <div style="font-weight:700;margin-top:12px">Camas â€” Inferior (pares)</div>
        <div class="beds-grid" id="bedsGridBottom"></div>
      </div>
      <div class="modal-footer">
        <div style="flex:1;align-self:center;color:var(--muted)"><span id="bedsCount">${selected.length}</span> selecionada(s) â€” necessÃ¡rio: ${maxBeds}</div>
        <button id="bedsCancel" class="btn">Cancelar</button>
        <button id="bedsConfirm" class="btn btn-primary">Confirmar</button>
      </div>
    `;
    overlay.appendChild(modal);

    const gridTop = modal.querySelector('#bedsGridTop');
    const gridBottom = modal.querySelector('#bedsGridBottom');

    function createBedHtml(b){
      const bid = b.id;
      const isReserved = reservedSet.has(bid);
      const isSelected = selected.includes(bid);
      const imgHtml = `<img src="${BED_BUTTON_IMAGE}" alt="beliche ${bid}" />`;
      const displayLabel = (b.label && b.label !== bid) ? b.label : bedIdToLabel(roomId, bid);
      return `<div class="bed-item ${isReserved ? 'reserved' : ''} ${isSelected ? 'selected' : ''}" data-bed="${bid}" ${isReserved ? 'aria-disabled="true"' : 'role="button"'}>${imgHtml}<div style="font-weight:700">${escapeHtml(displayLabel)}</div><div style="font-size:0.85rem">${isReserved ? 'IndisponÃ­vel' : 'DisponÃ­vel'}</div></div>`;
    }

    function renderBeds(){
      gridTop.innerHTML = topBeds.map(createBedHtml).join('');
      gridBottom.innerHTML = bottomBeds.map(createBedHtml).join('');
      modal.querySelector('#bedsCount').textContent = selected.length;
      [gridTop, gridBottom].forEach(grid => {
        grid.querySelectorAll('.bed-item').forEach(el=>{
          if(el.classList.contains('reserved')) return;
          el.addEventListener('click', ()=>{
            const id = el.dataset.bed;
            const idx = selected.indexOf(id);
            if(idx >= 0){
              selected.splice(idx,1);
              el.classList.remove('selected');
            } else {
              if(selected.length >= maxBeds) {
                el.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-6px)' }, { transform: 'translateX(0)' }], { duration: 180 });
                grid.querySelectorAll('.bed-item.selected').forEach(s => {
                  s.animate([{ boxShadow: '0 14px 40px rgba(39,174,96,0.18)' }, { boxShadow: '0 14px 40px rgba(39,174,96,0.36)' }, { boxShadow: '0 14px 40px rgba(39,174,96,0.18)' }], { duration: 260 });
                });
                return;
              }
              selected.push(id);
              el.classList.add('selected');
            }
            modal.querySelector('#bedsCount').textContent = selected.length;
          });
        });
      });
    }
    renderBeds();

    function closeAll(){ overlay.classList.remove('show'); overlay.innerHTML=''; overlay.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', onKey); }
    function onKey(e){ if(e.key==='Escape') closeAll(); }

    modal.querySelector('#bedsClose')?.addEventListener('click', closeAll);
    modal.querySelector('#bedsCancel')?.addEventListener('click', closeAll);
    modal.querySelector('#bedsConfirm')?.addEventListener('click', ()=> {
      if(selected.length !== maxBeds){
        alert(`Por favor selecione exatamente ${maxBeds} cama(s). Atualmente selecionadas: ${selected.length}.`);
        return;
      }
      if(typeof onConfirm === 'function') onConfirm(selected.slice());
      closeAll();
    });
    overlay.addEventListener('click', ev => { if(ev.target === overlay) closeAll(); });
    document.addEventListener('keydown', onKey);
  }

  // openSuitesModal remains available for grouped suite behavior but for individual suite cards we simply toggle selection in the reservation card
  function openSuitesModal({ checkin = null, checkout = null, preselected = [], onConfirm = null } = {}) {
    const overlay = qs('#calendarOverlay');
    overlay.innerHTML = '';
    overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');

    const avail = checkAvailability('q777', checkin, checkout);
    const allS = [];
    if(SHEETS && Array.isArray(SHEETS.suites) && SHEETS.suites.length){
      SHEETS.suites.forEach(r => {
        const sid = (r.suite_id || r.suite || r.id || r.name || '').trim();
        if(sid) allS.push(sid);
      });
    }
    if(allS.length === 0) allS.push('S1','S2','S3');
    const reservedSet = new Set(allS.filter(sid => !(avail.availableSuites || []).includes(sid) || RESERVED.reservedAllSuites.has(sid)));

    let selected = Array.from(preselected || []);

    const modal = document.createElement('div');
    modal.className = 'modal popup-small';
    modal.setAttribute('role','dialog');
    modal.setAttribute('aria-modal','true');
    modal.innerHTML = `
      <div class="modal-header">
        <h3>Selecionar suÃ­tes</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="suitesClose" class="btn" aria-label="Fechar">Ã—</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="color:var(--muted);margin-bottom:8px">Escolha as suÃ­tes disponÃ­veis. ${checkin && checkout ? `PerÃ­odo: ${formatBR(checkin)} â€” ${formatBR(checkout)}` : ''}</div>
        <div class="beds-grid" id="suitesGrid"></div>
      </div>
      <div class="modal-footer">
        <div style="flex:1;align-self:center;color:var(--muted)"><span id="suitesCount">${selected.length}</span> selecionada(s)</div>
        <button id="suitesCancel" class="btn">Cancelar</button>
        <button id="suitesConfirm" class="btn btn-primary">Confirmar</button>
      </div>
    `;
    overlay.appendChild(modal);

    const grid = modal.querySelector('#suitesGrid');
    function renderSuites(){
      grid.innerHTML = allS.map(sid => {
        const isReserved = reservedSet.has(sid);
        const isSelected = selected.includes(sid);
        const imgHtml = `<img src="${SUITE_BUTTON_IMAGE}" alt="suÃ­te ${sid}" />`;
        return `<div class="suite-item ${isReserved ? 'reserved' : ''} ${isSelected ? 'selected' : ''}" data-suite="${sid}" ${isReserved ? 'aria-disabled="true"' : 'role="button"'}>${imgHtml}<div style="font-weight:700">${sid}</div><div style="font-size:0.85rem">${isReserved ? 'IndisponÃ­vel' : 'Privativa'}</div></div>`;
      }).join('');
      modal.querySelector('#suitesCount').textContent = selected.length;
      grid.querySelectorAll('.suite-item').forEach(el=>{
        if(el.classList.contains('reserved')) return;
        el.addEventListener('click', ()=>{
          const id = el.dataset.suite;
          const idx = selected.indexOf(id);
          if(idx >= 0){ selected.splice(idx,1); el.classList.remove('selected'); } else { selected.push(id); el.classList.add('selected'); }
          modal.querySelector('#suitesCount').textContent = selected.length;
        });
      });
    }
    renderSuites();

    function closeAll(){ overlay.classList.remove('show'); overlay.innerHTML = ''; overlay.setAttribute('aria-hidden','true'); document.removeEventListener('keydown', onKey); }
    function onKey(e){ if(e.key==='Escape') closeAll(); }

    modal.querySelector('#suitesClose')?.addEventListener('click', closeAll);
    modal.querySelector('#suitesCancel')?.addEventListener('click', closeAll);
    modal.querySelector('#suitesConfirm')?.addEventListener('click', ()=> {
      if(typeof onConfirm === 'function') onConfirm(selected.slice());
      closeAll();
    });
    overlay.addEventListener('click', ev => { if(ev.target === overlay) closeAll(); });
    document.addEventListener('keydown', onKey);
  }

  function openCalendarSmall({ roomId = null, initialDate = null, onSelect = null }){
    calSmallState.roomId = roomId;
    calSmallState.currentDate = initialDate ? parseLocalDate(initialDate) : new Date();
    calSmallState.onSelect = onSelect;

    const overlay = qs('#calendarOverlay');
    overlay.innerHTML = '';
    overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');

    const modal = document.createElement('div');
    modal.className = 'modal popup-small';
    modal.innerHTML = `
      <div class="modal-header">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="calPrevSmall" class="btn" aria-label="MÃªs anterior">â€¹</button>
        </div>
        <h3 id="calTitleSmall"></h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="calNextSmall" class="btn" aria-label="PrÃ³ximo mÃªs">â€º</button>
          <button id="calCloseSmall" class="btn" aria-label="Fechar">Ã—</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="calendar-small">
          <div class="calendar-weekdays" aria-hidden="true">
            <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div><div>Dom</div>
          </div>
          <div class="calendar-grid-small" id="calendarGridSmall"></div>
          <div class="calendar-legend" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="calCloseSmallFooter" class="btn">Fechar</button>
      </div>
    `;
    overlay.appendChild(modal);

    modal.querySelector('#calPrevSmall')?.addEventListener('click', ()=> { calSmallState.currentDate = new Date(calSmallState.currentDate.getFullYear(), calSmallState.currentDate.getMonth()-1, 1); renderCalendarSmall(); });
    modal.querySelector('#calNextSmall')?.addEventListener('click', ()=> { calSmallState.currentDate = new Date(calSmallState.currentDate.getFullYear(), calSmallState.currentDate.getMonth()+1, 1); renderCalendarSmall(); });
    modal.querySelector('#calCloseSmall')?.addEventListener('click', closeCalendarSmall);
    modal.querySelector('#calCloseSmallFooter')?.addEventListener('click', closeCalendarSmall);

    renderCalendarSmall();
  }

  function closeCalendarSmall(){ const o = qs('#calendarOverlay'); if(!o) return; o.classList.remove('show'); o.innerHTML = ''; calSmallState.roomId = null; calSmallState.onSelect = null; }

  function renderCalendarSmall(){
    const modal = qs('#calendarOverlay .modal'); if(!modal) return;
    const monthNames = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const month = calSmallState.currentDate.getMonth(), year = calSmallState.currentDate.getFullYear();
    const titleEl = qs('#calTitleSmall'); if(titleEl) titleEl.textContent = `${monthNames[month]} ${year}`;

    const rawFirst = new Date(year, month, 1).getDay();
    const firstDay = (rawFirst + 6) % 7;

    const daysInMonth = new Date(year, month+1, 0).getDate();
    const grid = qs('#calendarGridSmall');
    grid.innerHTML = '';

    for(let i=0;i<firstDay;i++){ const empty = document.createElement('div'); empty.className = 'calendar-day-small empty'; grid.appendChild(empty); }

    const today = new Date(); today.setHours(0,0,0,0);

    const colors = ROOM_CAL_COLORS[calSmallState.roomId] || { available:'#e6f6ea', reserved:'#fdecea', textAvailable:'#1e8449', textReserved:'#b91c1c', swatchAvailable:'#e8f7ef', swatchReserved:'#fdecea' };

    for(let d=1; d<=daysInMonth; d++){
      const dateObj = new Date(year, month, d); dateObj.setHours(0,0,0,0);
      const dateStr = formatLocalDateJS(dateObj);
      const div = document.createElement('div');

      const isPast = dateObj < today;
      const isAvailable = calSmallState.roomId ? isRoomAvailableOnDate(calSmallState.roomId, dateStr) : true;
      const isUnavailable = !isAvailable || isPast;

      div.className = 'calendar-day-small ' + (isUnavailable ? 'reserved' : 'available');
      if(isPast) div.classList.add('past');

      div.innerHTML = `<div class="cal-day-num">${d}</div>`;
      div.style.background = isUnavailable ? colors.reserved : colors.available;
      div.style.color = isUnavailable ? colors.textReserved : colors.textAvailable;

      if(isUnavailable){
        div.setAttribute('aria-disabled','true');
        div.addEventListener('click', (e)=> e.stopPropagation());
      } else {
        div.addEventListener('click', ()=> {
          if(typeof calSmallState.onSelect === 'function') calSmallState.onSelect(dateStr);
          closeCalendarSmall();
        });
      }
      grid.appendChild(div);
    }

    const legend = modal.querySelector('.calendar-legend');
    if(legend){
      legend.innerHTML = `
        <div style="display:flex;align-items:center;gap:6px;margin-right:12px">
          <span class="swatch" style="background:${colors.swatchAvailable};border:1px solid rgba(30,132,73,0.12)"></span>
          <span>DisponÃ­vel</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span class="swatch" style="background:${colors.swatchReserved};border:1px solid rgba(185,28,28,0.08)"></span>
          <span>Reservado / IndisponÃ­vel</span>
        </div>
      `;
    }
  }

  function renderReservationCards(){
    const container = qs('#reservationCards');
    if(!container) return;
    container.innerHTML = staticRooms.map(r => {
      const styleAttr = (typeof ROOM_CARD_STYLES !== 'undefined' && ROOM_CARD_STYLES[r.roomId]) ? `style="${ROOM_CARD_STYLES[r.roomId]}"` : '';
      return `
      <div class="reservation-card" data-roomid="${r.roomId}" ${styleAttr}>
        <h3 style="margin-top:0;color:#fff">${r.name}</h3>
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <div class="form-group"><label>Check-in</label><input type="text" data-role="checkin" placeholder="Selecionar perÃ­odo" readonly /></div>
          </div>
          <div style="width:140px">
            <div class="form-group"><label>Check-out</label><input type="text" data-role="checkout" placeholder="Selecionar perÃ­odo" readonly /></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">
            <div class="form-group"><label>HÃ³spedes</label><select data-role="guests">${Array.from({length:14},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select></div>
          </div>
          <div style="width:140px">
            <div class="form-group"><label>Selecionar</label><button class="btn-select" data-role="selectbeds">${r.isSuite ? 'Selecionar suÃ­te' : (r.roomId==='q777' ? 'Selecionar suÃ­tes' : 'Selecionar camas')}</button></div>
          </div>
        </div>

        <div data-role="guestinfo" style="margin-top:12px"></div>

        <div style="margin-top:8px;color:var(--muted)">
          <label style="display:block;color:rgba(255,255,255,0.95)"><input type="checkbox" data-role="early" /> Check-in antecipado (+${formatCurrency(getExtraPrice('early_checkin'))})</label>
          <label style="display:block;color:rgba(255,255,255,0.95)"><input type="checkbox" data-role="late" /> Check-out estendido (+${formatCurrency(getExtraPrice('late_checkout'))})</label>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="transfer-btn" data-role="transfer-in">Transfer ida Aeroporto x Hostel (${formatCurrency(getExtraPrice('transfer_arrival'))})</button>
          <button class="transfer-btn" data-role="transfer-out">Transfer volta Hostel x Aeroporto (${formatCurrency(getExtraPrice('transfer_departure'))})</button>
        </div>

        <div class="price-summary" style="margin-top:12px">
          <div class="price-line"><span>Hospedagem</span><span data-role="base">R$ 0,00</span></div>
          <div class="price-line"><span>Extras</span><span data-role="extras">R$ 0,00</span></div>
          <div class="price-line" style="font-weight:700"><span>Total</span><span data-role="total">R$ 0,00</span></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-primary" data-role="reserve">Conferir disponibilidade</button>
        </div>
      </div>
    `}).join('');

    qsa('.reservation-card').forEach(card => {
      const roomId = card.dataset.roomid;
      const roomObj = staticRooms.find(s => s.roomId === roomId);
      const checkinInput = card.querySelector('[data-role="checkin"]');
      const checkoutInput = card.querySelector('[data-role="checkout"]');
      const guestsSelect = card.querySelector('[data-role="guests"]');
      const selectBedsBtn = card.querySelector('[data-role="selectbeds"]');
      const earlyCb = card.querySelector('[data-role="early"]');
      const lateCb = card.querySelector('[data-role="late"]');
      const transferInBtn = card.querySelector('[data-role="transfer-in"]');
      const transferOutBtn = card.querySelector('[data-role="transfer-out"]');
      const baseEl = card.querySelector('[data-role="base"]');
      const extrasEl = card.querySelector('[data-role="extras"]');
      const totalEl = card.querySelector('[data-role="total"]');
      const reserveBtn = card.querySelector('[data-role="reserve"]');
      const guestInfoContainer = card.querySelector('[data-role="guestinfo"]');

      const state = { checkin:null, checkout:null, guests:1, selectedBeds:[], selectedSuites:[], early:false, late:false, transferIn:false, transferOut:false, guestInfo: [] };

      function ensureGuestInfo(n){ state.guestInfo = state.guestInfo || []; while(state.guestInfo.length < n) state.guestInfo.push({ name: '', id: '' }); if(state.guestInfo.length > n) state.guestInfo = state.guestInfo.slice(0, n); }
      ensureGuestInfo(1);

      function renderGuestFields(){
        ensureGuestInfo(state.guests);
        guestInfoContainer.innerHTML = '';
        for(let i=0;i<state.guests;i++){
          const g = state.guestInfo[i] || { name:'', id:'' };
          const block = document.createElement('div');
          block.style.marginBottom = '8px';
          block.innerHTML = `
            <div style="font-weight:700;margin-bottom:6px;color:rgba(255,255,255,0.95)">HÃ³spede ${i+1}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input type="text" placeholder="Nome do hÃ³spede ${i+1}" data-guest-name="${i}" style="flex:1;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.04);color:#fff" />
              <input type="text" placeholder="CPF ou passaporte" data-guest-id="${i}" style="width:200px;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.04);color:#fff" />
            </div>
          `;
          guestInfoContainer.appendChild(block);
        }
        guestInfoContainer.querySelectorAll('[data-guest-name]').forEach(inp=>{
          inp.addEventListener('input', e=>{
            const idx = Number(e.target.getAttribute('data-guest-name'));
            ensureGuestInfo(state.guests);
            state.guestInfo[idx].name = e.target.value.trim();
          });
        });
        guestInfoContainer.querySelectorAll('[data-guest-id]').forEach(inp=>{
          inp.addEventListener('input', e=>{
            const idx = Number(e.target.getAttribute('data-guest-id'));
            ensureGuestInfo(state.guests);
            state.guestInfo[idx].id = e.target.value.trim();
          });
        });
        guestInfoContainer.querySelectorAll('[data-guest-name]').forEach(el=>{
          const idx = Number(el.getAttribute('data-guest-name'));
          el.value = state.guestInfo[idx] ? state.guestInfo[idx].name : '';
        });
        guestInfoContainer.querySelectorAll('[data-guest-id]').forEach(el=>{
          const idx = Number(el.getAttribute('data-guest-id'));
          el.value = state.guestInfo[idx] ? state.guestInfo[idx].id : '';
        });
      }

      function updatePriceUI(){ const { baseTotal } = computeDynamicPricing(roomId, state.checkin, state.checkout, state.guests, state.selectedBeds, state.selectedSuites); let extras = 0;
        if (state.early) extras += (getExtraPrice('early_checkin') || 0) * state.guests;
        if (state.late) extras += (getExtraPrice('late_checkout') || 0) * state.guests;
        if (state.transferIn) extras += getExtraPrice('transfer_arrival') || 0;
        if (state.transferOut) extras += getExtraPrice('transfer_departure') || 0;
        baseEl.textContent = formatCurrency(baseTotal || 0);
        extrasEl.textContent = formatCurrency(extras || 0);
        totalEl.textContent = formatCurrency((baseTotal || 0) + extras);
      }

      function openSmallCalFor(field){ openCalendarSmall({ roomId, initialDate: field === 'checkin' ? state.checkin : state.checkout, onSelect: (dateStr) => { if(field === 'checkin'){ if(state.checkout){ const sel = parseLocalDate(dateStr); const co = parseLocalDate(state.checkout); if(sel >= co){ alert('Check-in nÃ£o pode ser igual ou posterior ao check-out. Escolha uma data anterior ao check-out.'); return; } } state.checkin = dateStr; checkinInput.value = formatBR(dateStr); } else { if(state.checkin){ const sel = parseLocalDate(dateStr); const ci = parseLocalDate(state.checkin); if(sel <= ci){ alert('Check-out deve ser posterior ao check-in. Escolha uma data posterior ao check-in.'); return; } } state.checkout = dateStr; checkoutInput.value = formatBR(dateStr); } updatePriceUI(); } }); }

      checkinInput.addEventListener('click', ()=> openSmallCalFor('checkin'));
      checkoutInput.addEventListener('click', ()=> openSmallCalFor('checkout'));

      guestsSelect.addEventListener('change', e => { state.guests = Number(e.target.value); if(state.selectedBeds.length > state.guests){ state.selectedBeds = state.selectedBeds.slice(0, state.guests); } ensureGuestInfo(state.guests); renderGuestFields(); selectBedsBtn.textContent = roomObj && roomObj.isSuite ? `Selecionar suÃ­te (${state.selectedSuites.length})` : (roomId==='q777' ? `Selecionar suÃ­tes (${state.selectedSuites.length})` : `Selecionar camas (${state.selectedBeds.length})`); updatePriceUI(); });

      renderGuestFields();

      selectBedsBtn.addEventListener('click', ()=> {
        // For individual suite cards: toggle the selection of this suite directly (no extra modal)
        if(roomObj && roomObj.isSuite){
          const sid = roomObj.suiteId;
          if(!sid){
            alert('Erro: suÃ­te nÃ£o identificada.');
            return;
          }
          // toggle
          if(state.selectedSuites.includes(sid)){
            state.selectedSuites = state.selectedSuites.filter(x => x !== sid);
          } else {
            state.selectedSuites = [sid];
          }
          selectBedsBtn.textContent = `Selecionar suÃ­te (${state.selectedSuites.length})`;
          updatePriceUI();
          return;
        }

        // For grouped suites (legacy q777) open the suites modal
        if(roomId === 'q777'){
          openSuitesModal({ checkin: state.checkin, checkout: state.checkout, preselected: state.selectedSuites, onConfirm: (sel)=> { state.selectedSuites = sel; selectBedsBtn.textContent = `Selecionar suÃ­tes (${sel.length})`; updatePriceUI(); } });
        } else {
          openBedsModal({ roomId, maxBeds: state.guests, preselected: state.selectedBeds, checkin: state.checkin, checkout: state.checkout, onConfirm: (sel)=> {
            state.selectedBeds = sel;
            selectBedsBtn.textContent = `Selecionar camas (${sel.length})`;
            updatePriceUI();
          } });
        }
      });

      earlyCb.addEventListener('change', e => { state.early = e.target.checked; updatePriceUI(); });
      lateCb.addEventListener('change', e => { state.late = e.target.checked; updatePriceUI(); });

      transferInBtn.addEventListener('click', () => { state.transferIn = !state.transferIn; transferInBtn.classList.toggle('active', state.transferIn); updatePriceUI(); });
      transferOutBtn.addEventListener('click', () => { state.transferOut = !state.transferOut; transferOutBtn.classList.toggle('active', state.transferOut); updatePriceUI(); });

      reserveBtn.addEventListener('click', () => {
        if(!state.checkin || !state.checkout){ alert('Por favor selecione check-in e check-out.'); return; }
        if(parseLocalDate(state.checkout) <= parseLocalDate(state.checkin)){ alert('Check-out deve ser apÃ³s check-in.'); return; }
        const avail = checkAvailability(roomId, state.checkin, state.checkout);
        if(!avail.isAvailable){ alert('Desculpe, o perÃ­odo contÃ©m dias reservados. Escolha outro intervalo.'); return; }
        if((roomObj && roomObj.isSuite) || roomId === 'q777'){
          if(state.selectedSuites.length===0){ alert('Selecione ao menos uma suÃ­te.'); return; }
        } else {
          if(state.selectedBeds.length !== state.guests){
            alert(`Para este quarto Ã© necessÃ¡rio selecionar exatamente ${state.guests} cama(s). Atualmente selecionadas: ${state.selectedBeds.length}.`);
            return;
          }
        }
        ensureGuestInfo(state.guests);
        for(let i=0;i<state.guests;i++){
          const g = state.guestInfo[i];
          if(!g || !g.name || !g.id){
            alert(`Por favor preencha o nome e CPF/passaporte do hÃ³spede ${i+1} antes de continuar.`);
            return;
          }
        }

        const nights = Math.ceil((parseLocalDate(state.checkout) - parseLocalDate(state.checkin)) / (1000*60*60*24));
        const bedsText = (roomObj && roomObj.isSuite) || roomId === 'q777' ? state.selectedSuites.join(', ') : state.selectedBeds.map(bid=>bedIdToLabel(roomId, bid)).join(', ');
        const { baseTotal } = computeDynamicPricing(roomId, state.checkin, state.checkout, state.guests, state.selectedBeds, state.selectedSuites);
        let total = baseTotal;
        if(state.early) total += (getExtraPrice('early_checkin') || 0) * state.guests;
        if(state.late) total += (getExtraPrice('late_checkout') || 0) * state.guests;
        if(state.transferIn) total += getExtraPrice('transfer_arrival') || 0;
        if(state.transferOut) total += getExtraPrice('transfer_departure') || 0;

        const roomName = roomObj ? roomObj.name : roomId;
        let message = `OlÃ¡! Gostaria de solicitar reserva para ${roomName}.\n\nðŸ“… Check-in: ${formatBR(state.checkin)}\nðŸ“… Check-out: ${formatBR(state.checkout)}\nðŸŒ™ Noites: ${nights}\nðŸ‘¥ HÃ³spedes: ${state.guests}\n${(roomObj && roomObj.isSuite) || roomId==='q777' ? 'ðŸ  SuÃ­tes' : 'ðŸ›ï¸ Camas'}: ${bedsText}\n\nðŸ‘¤ Dados dos hÃ³spedes:\n`;
        state.guestInfo.forEach((g, idx) => { message += `- ${idx+1}. ${g.name} â€” ${g.id}\n`; });
        message += `\nðŸ’° Resumo:\n- Valor base: ${formatCurrency(baseTotal)}`;
        if(state.early) message += `\n- Check-in antecipado (por pessoa): ${formatCurrency(getExtraPrice('early_checkin'))} Ã— ${state.guests} = ${formatCurrency((getExtraPrice('early_checkin')||0) * state.guests)}`;
        if(state.late) message += `\n- Check-out estendido (por pessoa): ${formatCurrency(getExtraPrice('late_checkout'))} Ã— ${state.guests} = ${formatCurrency((getExtraPrice('late_checkout')||0) * state.guests)}`;
        if(state.transferIn) message += `\n- Transfer ida: ${formatCurrency(getExtraPrice('transfer_arrival'))}`;
        if(state.transferOut) message += `\n- Transfer volta: ${formatCurrency(getExtraPrice('transfer_departure'))}`;
        message += `\n\nðŸ’µ Total: ${formatCurrency(total)}\n\nObrigado!`;
        window.open(`https://wa.me/5521997305179?text=${encodeURIComponent(message)}`, '_blank');
      });

      updatePriceUI();
    });
  }

  async function fetchSheet(gid, retry=0){
    const id = SHEET_ID;
    if(!id) throw new Error('SHEET_ID nÃ£o configurado');
    const url = SHEET_URL(id) + gid;
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      return parseCSV(txt);
    }catch(err){
      if(retry<1){ await new Promise(r=>setTimeout(r,800)); return fetchSheet(gid, retry+1) }
      throw err
    }
  }

  function getCached(){ try{ const raw = localStorage.getItem(CACHE_KEY); if(!raw) return null; const p = JSON.parse(raw); if(!p.timestamp) return null; if(Date.now() - p.timestamp > CACHE_DURATION){ localStorage.removeItem(CACHE_KEY); return null; } return p.data; }catch{ return null } }
  function setCached(data){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() })); }catch(e){ console.warn(e) } }

  async function loadSheets(){
    const cached = getCached();
    if(cached){ SHEETS = cached; applySavedRoomDescs(); buildReservedMapsFromSheets(); renderAll(); refreshSheets(); return }
    if(!SHEET_ID){ SHEETS = { calendar:[], pricing:[], rooms:[], beds:[], suites:[], extras:[] }; applySavedRoomDescs(); buildReservedMapsFromSheets(); renderAll(); return }
    try{
      const [calendar, pricing, rooms, beds, suites, extras] = await Promise.all([
        fetchSheet(SHEET_GIDS.calendar),
        fetchSheet(SHEET_GIDS.pricing),
        fetchSheet(SHEET_GIDS.rooms),
        fetchSheet(SHEET_GIDS.beds),
        fetchSheet(SHEET_GIDS.suites),
        fetchSheet(SHEET_GIDS.extras)
      ]);
      SHEETS = { calendar, pricing, rooms, beds, suites, extras };
      setCached(SHEETS);
      applySavedRoomDescs();
      buildReservedMapsFromSheets();
      renderAll();
    }catch(err){
      console.warn('Erro ao carregar sheets:', err);
      SHEETS = { calendar:[], pricing:[], rooms:[], beds:[], suites:[], extras:[] };
      applySavedRoomDescs();
      buildReservedMapsFromSheets();
      renderAll();
    }
  }

  async function refreshSheets(){ if(!SHEET_ID) return; try{ const [calendar, pricing, rooms, beds, suites, extras] = await Promise.all([ fetchSheet(SHEET_GIDS.calendar), fetchSheet(SHEET_GIDS.pricing), fetchSheet(SHEET_GIDS.rooms), fetchSheet(SHEET_GIDS.beds), fetchSheet(SHEET_GIDS.suites), fetchSheet(SHEET_GIDS.extras) ]); SHEETS = { calendar, pricing, rooms, beds, suites, extras }; setCached(SHEETS); applySavedRoomDescs(); buildReservedMapsFromSheets(); renderAll(); }catch(e){ console.warn('refresh failed', e);} }

  function fallbackSheets(){ return { calendar: [], pricing: [], rooms: [], beds: [], suites: [], extras: [] }; }

  function renderAll(){ renderBenefits(); renderTestimonials(); renderRoomsGrid(); renderReservationCards(); }

  (function heroCycle(){
    const slides = qsa('.hero-slide'); const indicators = qs('#heroIndicators'); if(!slides.length) return;
    let idx=0, paused=false, timer=null;
    function renderIndicators(){ if(!indicators) return; indicators.innerHTML = slides.map((_,i)=>`<button data-i="${i}" class="${i===idx?'active':''}" aria-label="slider button ${i+1}"></button>`).join(''); indicators.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=> { idx = Number(b.dataset.i); update(); reset(); })); }
    function update(){ slides.forEach((s,i)=> s.classList.toggle('active', i===idx)); renderIndicators(); }
    function next(){ idx = (idx+1) % slides.length; update(); }
    function prev(){ idx = (idx-1+slides.length) % slides.length; update(); }
    function reset(){ if(timer) clearInterval(timer); timer = setInterval(()=>{ if(!paused) next(); }, 5000); }
    qs('#heroNext')?.addEventListener('click', ()=> { next(); reset(); });
    qs('#heroPrev')?.addEventListener('click', ()=> { prev(); reset(); });
    qs('#hero')?.addEventListener('mouseenter', ()=> paused = true);
    qs('#hero')?.addEventListener('mouseleave', ()=> paused = false);
    [qs('#toReservationBtn'), qs('#toReservationBtn2')].forEach(b => b && b.addEventListener('click', ()=> qs('#reservationSection').scrollIntoView({behavior:'smooth'})));
    [qs('#toRoomsBtn'), qs('#toRoomsBtn2')].forEach(b => b && b.addEventListener('click', ()=> qs('#roomsSection').scrollIntoView({behavior:'smooth'})));
    renderIndicators(); update(); reset();
  })();

  (function init(){ document.documentElement.lang='pt-BR'; document.documentElement.setAttribute('translate','no'); applySavedRoomDescs(); renderAll(); loadSheets(); })();

  </script>
</body>
</html>
